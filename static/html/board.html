<!doctype html>
<html>
<head>
    <title>Demo &raquo; Serialize &raquo; gridster.js</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
    <link rel="stylesheet" type="text/css" href="../css/demo.css">
    <link rel="stylesheet" type="text/css" href="../libs/gridster/jquery.gridster.min.css">
    <script src="../libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="../libs/gridster/jquery.gridster.min.js" type="text/javascript" charset="utf-8"></script>

    <style type="text/css">
        #log {
            display: block;
            width: 100%;
            height: 20px;
            margin-bottom: 20px;

            -webkit-transition: height 0.3s ease;
            -moz-transition: height 0.3s ease;
            -ms-transition: height 0.3s ease;
            -o-transition: height 0.3s ease;
            transition: height 0.3s ease;
        }

        #log:focus {
            height: 100px;
        }

        .delete{
            position: absolute;
            top: 0;
            left: 175px;
            display: block;
            width: 30px;
            height: 20px;
            color: #FFF;
            background: #888;
            opacity: 0.4;
            text-align: center;
            text-decoration: none;
            border: none;
        }

        .delete:hover{
            background: #888;
            opacity: 0.8;
        }
        li:hover .add{
                display: block;
        }
        .add{
            background: #ffffff;
            opacity: 0.4;
            width: 45px;
            height: 30px;
            position:absolute;
            top: 145px;
            left: 160px;
            color: #000000;
            border:none;
            font-size: 2em;
            text-align: center;
            align-content: center;
            display:none;
        }
        .write{
            border: none;
            width:30px;
            height: 30px;
            position:absolute;
            background-image: url("../img/write.png");
            opacity: 0.4;
            left: 175px;
            top:75px;
        }
    </style>
</head>

<body>

<h1>Serialize positions</h1>

<p>Use <code>serialize</code> method to get widget positions. It returns a Array of objects that can be used as a JSON object.</p>

<div class="controls">
    <button class="js-seralize">Serialize</button>
</div>

<textarea id="log"></textarea>

<div id="activity" class="gridster" >
    <ul>
        <li  data-row="1" data-col="1" data-sizex="2" data-sizey="3" style="background:#aed9e9">
            <div>
                <button class="delete">x</button>
                <button class="add" >+</button>
                <Imagebutton class="write"></Imagebutton>
             </div>
        </li>
    </ul>
</div>

<div id="tasks" class="gridster">
<ul>
    <li  data-row="1" data-col="1" data-sizex="2" data-sizey="3"  style="background:#f4e459">
        <div>
            <button class="delete">x</button>
            <button class="add" >+</button>
            <Imagebutton class="write"></Imagebutton>
        </div>
    </li>
</ul>
</div>

<div id="releases" class="gridster">
    <ul>
        <li  data-row="1" data-col="1" data-sizex="2" data-sizey="3"  style="background:#ffffff">
            <div>
                <button class="delete">x</button>
                <button class="add" >+</button>
                <Imagebutton class="write"></Imagebutton>
            </div>
        </li>
    </ul>
</div>

<script type="text/javascript">
    var gridster = [];

    $(function () {

        gridster[0] = $("#activity ul").gridster({
            widget_base_dimensions: [100, 55],
            widget_margins: [5, 5],
            shift_widgets_up: false,
            shift_larger_widgets_down: false,
            collision: {
                wait_for_mouseup: true
            }
        }).data('gridster');

        gridster[1] = $("#tasks ul").gridster({
            widget_base_dimensions: [100, 55],
            widget_margins: [10, 10],
            shift_widgets_up: false,
            shift_larger_widgets_down: false,
            collision: {
                wait_for_mouseup: true
            }
        }).data('gridster');

        gridster[2] = $("#releases ul").gridster({
            widget_base_dimensions: [200, 110],
            widget_margins: [15, 15],
            shift_widgets_up: false,
            shift_larger_widgets_down: false,
            collision: {
                wait_for_mouseup: true
            }
        }).data('gridster');

        $('.js-seralize').on('click', function () {
            s = []
            gridster[0].$widgets.each(function (i) { // map格式存储，i只是index
                let w = gridster[0].$widgets[i]
                let arr = gridster[0].serialize($(w))
                arr[0].text = w.textContent
                s = s.concat(arr)
            })
            $('#log').val(JSON.stringify(s));
        })

        $(document).on('click','li .add',function () {
            //获取点击按钮的最上层父元素
            var i=$(this).parent().parent().index();
            //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
            var j=$(this).parent().parent().parent().parent().attr('id');
            if(j=="activity"){
                var content=gridster[0].serialize($(gridster[0].$widgets[i]));
                gridster[0].add_widget('<li style="background:#aed9e9"><div>' +
                    '                <button class="delete">x</button>' +
                    '                <button class="add" >+</button><Imagebutton class="write"></Imagebutton>' +
                    '             </div></li>',2,3,content[0].col+2,content[0].row);
            }
            if(j=="tasks"){
                var content=gridster[1].serialize($(gridster[1].$widgets[i]));
                gridster[1].add_widget('<li style="background:#f4e459"><div>' +
                    '                <button class="delete">x</button>' +
                    '                <button class="add" >+</button><Imagebutton class="write"></Imagebutton>' +
                    '             </div></li>',2,3,content[0].col+2,content[0].row);
            }
            if(j=="releases"){
                var content=gridster[2].serialize($(gridster[2].$widgets[i]));
                gridster[2].add_widget('<li style="background:#ffffff"><div>' +
                    '                <button class="delete">x</button>' +
                    '                <button class="add" >+</button><Imagebutton class="write"></Imagebutton>' +
                    '             </div></li>',2,3,content[0].col+2,content[0].row);
            }

        })

        $(document).on('click','li .delete',function(){
            //获取点击按钮的最上层父元素
            var i=$(this).parent().parent().index();
            //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
            var j=$(this).parent().parent().parent().parent().attr('id');
            if(j=="activity"){
                gridster[0].remove_widget($('#activity li').eq(i));
            }
            if(j=="tasks"){
                gridster[1].remove_widget($('#tasks li').eq(i));
            }
            if(j=="releases"){
                gridster[2].remove_widget($('#releases li').eq(i));
            }
        })

        $(document).on('click','li .write',function () {
            // if(gridster[0].draggable()){
            //     $(this).blur();
            // }
            var item=$(this).index();
            // console.log("下标索引值为：" +item);
            var word = prompt("请输入一段文字","");
            if(word){
                // console.log($(this).prop("tagName"));
                // $(this).text(word);
                var string=word+"<button class='delete'>x</button>" +
                    "<button class='add' >+</button>"+"<Imagebutton class='write'></Imagebutton>";
                $(this).html(string);
            }
            // $("#refuse_word").val(refuse_word);
            // gridster[0].$widgets[item].innerText=word;
        })
    });
</script>
</body>
</html>
