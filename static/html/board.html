<!doctype html>
<html>

<head>
    <title>Demo &raquo; Serialize &raquo; gridster.js</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/demo.css">
    <link rel="stylesheet" type="text/css" href="../libs/gridster/jquery.gridster.min.css">
    <script src="../libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="../libs/gridster/jquery.gridster.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../libs/layer/layer.js"></script>
    <link href="../libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        #log {
            display: block;
            width: 100%;
            height: 20px;
            margin-bottom: 20px;

            -webkit-transition: height 0.3s ease;
            -moz-transition: height 0.3s ease;
            -ms-transition: height 0.3s ease;
            -o-transition: height 0.3s ease;
            transition: height 0.3s ease;
        }

        #log:focus {
            height: 100px;
        }

        .delete {
            position: absolute;
            top: 0;
            left: 175px;
            color: #FFF;
            opacity: 0.4;
            text-align: center;
            text-decoration: none;
            border: none;
        }

        .delete:hover {
            opacity: 0.8;
        }

        li:hover .add {
            display: block;
        }

        .add {
            background: #ffffff;
            opacity: 0.4;
            position: absolute;
            top: 130px;
            left: 160px;
            color: #000000;
            border: none;
            align-content: center;
            display: none;
        }

        .write {
            border: none;
            width: 30px;
            height: 30px;
            position: absolute;
            opacity: 0.4;
            left: 175px;
            top: 75px;
        }
        .write:hover {
            opacity: 0.8;
        }

        li:hover .add_below{
            display: block;
        }

        .add_below{
            background: #fff;
            opacity: 0.4;
            position: absolute;
            top: 130px;
            left:80px;
            color: #000000;
            border: none;
            text-align: center;
            align-content: center;
            display: none;
        }
    </style>
</head>

<body>
    <div class="controls">
        <button class="js-seralize">序列化坐标和内部文本</button>
        <button class="js-reload-from-array">从序列化数据加载</button>
        <button id="testb">test</button>
    </div>

    <textarea id="log"></textarea>

    <div id="activity" class="gridster card">
        <ul>
        </ul>
    </div>

    <div id="tasks" class="gridster card">
        <ul>
        </ul>
    </div>

    <div id="releases" class="gridster card">
        <ul>
        </ul>
    </div>

    <script type="text/javascript">
        var gridsters = [];
        let gridster_style = {
            widget_base_dimensions: [100, 50],
            widget_margins: [5, 5],
            shift_widgets_up: false,
            shift_larger_widgets_down: false,
            collision: {
                wait_for_mouseup: true
            }
        };

        $(function () {
            gridsters[0] = $("#activity ul").gridster(gridster_style).data('gridster');
            gridsters[1] = $("#tasks ul").gridster(gridster_style).data('gridster');
            gridsters[2] = $("#releases ul").gridster(gridster_style).data('gridster');

            $('.js-seralize').on('click', function () {
                let s = [];
                gridsters[2].$widgets.each(function (i) { // map格式存储，i只是index
                    let w = gridsters[2].$widgets[i];
                    let arr = gridsters[2].serialize($(w));
                    arr[0].text = w.textContent;
                    s = s.concat(arr)
                });
                $('#log').val(JSON.stringify(s));
            });

            // reload button
            $('.js-reload-from-array').on('click', function () {
                // same object that generated with gridster.serialize() method
                var serialization = [
                    {col: 1, row: 1, size_x: 2, size_y: 3},
                    {col: 3, row: 1, size_x: 2, size_y: 3}
                ];
                // sort serialization
                serialization = Gridster.sort_by_row_and_col_asc(serialization);
                gridsters[0].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[0].add_widget(card_html('#aed9e9'), this.size_x, this.size_y, this.col, this.row);
                });
                gridsters[1].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[1].add_widget(card_html('#aed9e9'), this.size_x, this.size_y, this.col, this.row);
                });
                gridsters[2].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[2].add_widget(card_html('#aed9e9'), this.size_x, this.size_y, this.col, this.row);
                });
            });

            function card_innerEl(text='') {
                return '<span class="card card-text">' + text + '</span>' +
                    '<i class="delete fa fa-window-close fa-2x"></i>' +
                    '<i class="add fa fa-chevron-circle-right fa-lg"></i>' +
                    '<i class="add_below fa fa-chevron-circle-down fa-lg"></i>' +
                    '<i class="write fa fa-pencil-square-o fa-lg"></i>';
            }
            function card_html(bg, text='') {
                return '<li style="background:' + bg + '"><div>' + card_innerEl(text) + '</div></li>';
            }
            $(document).on('click', 'li .add', function () {
                //获取点击按钮的最上层父元素
                var i = $(this).parent().parent().index();
                //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
                var j = $(this).parent().parent().parent().parent().attr('id');
                if (j === "activity") {
                    let content = gridsters[0].serialize($(gridsters[0].$widgets[i]));
                    gridsters[0].add_widget(card_html('#aed9e9'), 2, 3, content[0].col + 2, content[0].row);
                }
                if (j === "tasks") {
                    let content = gridsters[1].serialize($(gridsters[1].$widgets[i]));
                    gridsters[1].add_widget(card_html('#f4e459'), 2, 3, content[0].col + 2, content[0].row);
                }
                if (j === "releases") {
                    let content = gridsters[2].serialize($(gridsters[2].$widgets[i]));
                    gridsters[2].add_widget(card_html('#fff'), 2, 3, content[0].col + 2, content[0].row);
                }

            });

            $(document).on('click', 'li .delete', function () {
                //获取点击按钮的最上层父元素
                let i = $(this).parent().parent().index();
                //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
                let j = $(this).parent().parent().parent().parent().attr('id');
                if (j === "activity") {
                    gridsters[0].remove_widget($('#activity li').eq(i));
                }
                if (j === "tasks") {
                    gridsters[1].remove_widget($('#tasks li').eq(i));
                }
                if (j === "releases") {
                    gridsters[2].remove_widget($('#releases li').eq(i));
                }
            });

            $(document).on('click', 'li .write', function(){
                let pencil = this;
                layer.prompt({
                    formType: 2,
                    shadeClose: true, //点击遮罩关闭层
                    title: '请输入内容',
                    value:'',    // 文本默认值
                    area: ['500px', '240px'],     // 设置弹出层大小
                    btn: ['保存', '取消'],    // 自定义设置多个按钮
                    btn1: function(index, elem){
                        layer.close(index);
                    },
                    btnAlign: 'c',    // 设置按钮位置
                }, function(value, index, elem){
                    if (value) {
                        // parent.$('.card-text').text(value);  // this will change all cards
                        let s = card_innerEl(value);
                        $(pencil.parentElement).html(s);
                    }
                    layer.close(index);
                });
            });

            $(document).on('click', 'li .add_below', function () {
                //获取点击按钮的最上层父元素
                var i = $(this).parent().parent().index();
                let content = gridsters[2].serialize($(gridsters[2].$widgets[i]));
                gridsters[2].add_widget(card_html('#fff'), 2, 3, content[0].col + 2, content[0].row);

            });
        });
    </script>
</body>

</html>
<!--Todo: 重新组织卡片的css样式，让卡片内元素继承卡片样式，使用margin和padding定位，使文字、按钮布局正常-->
