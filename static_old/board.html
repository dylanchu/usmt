<!DOCTYPE html>
<html>

<head>
    <title>Demo &raquo; Serialize &raquo; gridster.js</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="css/demo.css">
    <link rel="stylesheet" type="text/css" href="libs/gridster/jquery.gridster.min.css">
    <script src="libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="libs/gridster/jquery.gridster.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="libs/layer/layer.js"></script>
    <link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        #log {
            display: block;
            width: 100%;
            height: 20px;
            margin-bottom: 20px;

            -webkit-transition: height 0.3s ease;
            -moz-transition: height 0.3s ease;
            -ms-transition: height 0.3s ease;
            -o-transition: height 0.3s ease;
            transition: height 0.3s ease;
        }

        #log:focus {
            height: 100px;
        }

        .delete {
            position: absolute;
            top: 0;
            left: 175px;
            color: #000000;
            opacity: 0.4;
            text-align: center;
            text-decoration: none;
            border: none;
            outline: none;
        }

        .delete:hover {
            opacity: 0.8;
        }

        li:hover .add {
            display: block;
        }

        .add {
            background: #ffffff;
            opacity: 0.4;
            position: absolute;
            top: 130px;
            left: 160px;
            color: #000000;
            border: none;
            align-content: center;
            display: none;
        }

        .write {
            border: none;
            width: 30px;
            height: 30px;
            position: absolute;
            opacity: 0.4;
            left: 175px;
            top: 75px;
        }
        .write:hover {
            opacity: 0.8;
        }

        li:hover .add_below{
            display: block;
        }

        .add_below{
            background: #fff;
            opacity: 0.4;
            position: absolute;
            top: 130px;
            left:80px;
            color: #000000;
            border: none;
            text-align: center;
            align-content: center;
            display: none;
        }

        p {
            margin: 6px;
            color:#61A9CF;
            font-family: "Times New Roman";
            font-weight: 700;
        }
    </style>
</head>

<body>
    <div class="controls">
        <button class="js-seralize">序列化坐标和内部文本</button>
        <button class="js-reload-from-array">从序列化数据加载</button>
        <button id="testb">test</button>
    </div>

    <textarea id="log"></textarea>

    <div id="activity" class="gridster card">
        <ul>
        </ul>
    </div>

    <div id="tasks" class="gridster card">
        <ul>
        </ul>
    </div>

    <p>- Release1</p>
    <div id="releases1" class="gridster card">
        <ul>
        </ul>
    </div>

    <p>- Release2</p>
    <div id="releases2" class="gridster card">
        <ul>
        </ul>
    </div>

    <script type="text/javascript">
        var gridsters = [];
        let gridster_style = {
            widget_base_dimensions: [100, 50],
            widget_margins: [5, 5],
            shift_widgets_up: false,
            shift_larger_widgets_down: false,
            collision: {
                wait_for_mouseup: true
            }
        };

        $(function () {
            gridsters[0] = $("#activity ul").gridster(gridster_style).data('gridster');
            gridsters[1] = $("#tasks ul").gridster(gridster_style).data('gridster');
            gridsters[2] = $("#releases1 ul").gridster(gridster_style).data('gridster');
            gridsters[3] = $("#releases2 ul").gridster(gridster_style).data('gridster');

            $('.js-seralize').on('click', function () {
                let s = [];
                gridsters[1].$widgets.each(function (i) { // map格式存储，i只是index
                    let w = gridsters[1].$widgets[i];
                    let arr = gridsters[1].serialize($(w));
                    arr[0].text = $(w).find($('span'))[0].textContent;
                    s = s.concat(arr)
                });
                $('#log').val(JSON.stringify(s));
            });

            // reload button
            $('.js-reload-from-array').on('click', function () {
                // same object that generated with gridster.serialize() method
                var serialization = [
                    {col: 1, row: 1, size_x: 2, size_y: 3},
                    {col: 3, row: 1, size_x: 2, size_y: 3}
                ];
                // sort serialization
                serialization = Gridster.sort_by_row_and_col_asc(serialization);
                gridsters[0].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[0].add_widget(card_html('#aed9e9','',"activity"), this.size_x, this.size_y, this.col, this.row);
                });
                gridsters[1].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[1].add_widget(card_html('#f4e459','',"tasks"), this.size_x, this.size_y, this.col, this.row);
                });
                gridsters[2].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[2].add_widget(card_html('#ffffff','',"releases1"), this.size_x, this.size_y, this.col, this.row);
                });
                gridsters[3].remove_all_widgets();
                $.each(serialization, function () {
                    gridsters[3].add_widget(card_html('#ffffff','',"releases2"), this.size_x, this.size_y, this.col, this.row);
                });
            });

            function card_innerEl(text,part) {
                let string= '<span class="card card-text">' + text + '</span>' +
                '<i class="delete fa fa-window-close fa-2x"></i>' +
                '<i class="add fa fa-chevron-circle-right fa-lg"></i>' +
                '<i class="write fa fa-pencil-square-o fa-lg"></i>';

                if(part=="activity" || part=="tasks"){
                    return string;
                }else{
                    return string+ '<i class="add_below fa fa-chevron-circle-down fa-lg"></i>';
                }
            }

            function card_html(bg, text,part) {
                return '<li style="background:' + bg + '"><div>' + card_innerEl(text,part) + '</div></li>';
            }

            //s复制后的对象数组，必须以此种方式复制，否则可能每次temp的改变都会影响s的改变
            function returnTemp(s){
                let temp=[];
                for(let l in s){
                    let obj={
                        col: s[l].col,
                        row: s[l].row,
                        size_x: 2,
                        size_y: 3,
                        text:s[l].text,
                    };
                    temp.push(obj);
                }
                return temp;
            }

            //找到触发点击事件的li右边是否存在li
            function returnIndex(s,a,b){
                let index=0;
                for(let m in s){
                    if(s[m].row==a && s[m].col==b+2){
                        index=m;
                    }
                }
                return index;
            }

            function getSerializeData(j){
                let s = [];
                if(j=="activity"){
                    gridsters[0].$widgets.each(function (i) { // map格式存储，i只是index
                        let w = gridsters[0].$widgets[i];
                        let arr = gridsters[0].serialize($(w));
                        arr[0].text = $(w).find($('span'))[0].textContent;
                        s = s.concat(arr)
                    });
                }
                if(j=="tasks"){
                    gridsters[1].$widgets.each(function (i) { // map格式存储，i只是index
                        let w = gridsters[1].$widgets[i];
                        let arr = gridsters[1].serialize($(w));
                        arr[0].text = $(w).find($('span'))[0].textContent;
                        s = s.concat(arr)
                    });
                }
                if(j=="releases1"){
                    gridsters[2].$widgets.each(function (i) { // map格式存储，i只是index
                        let w = gridsters[2].$widgets[i];
                        let arr = gridsters[2].serialize($(w));
                        arr[0].text = $(w).find($('span'))[0].textContent;
                        s = s.concat(arr)
                    });
                }
                if(j=="releases2"){
                    gridsters[3].$widgets.each(function (i) { // map格式存储，i只是index
                        let w = gridsters[3].$widgets[i];
                        let arr = gridsters[3].serialize($(w));
                        arr[0].text = $(w).find($('span'))[0].textContent;
                        s = s.concat(arr)
                    });
                }
                return s;
            }

            function process(temp,index,row,s,j){
                for(let n in temp){
                    if(temp[n].row ==row  && n>=index){
                        temp[n].col+=2;
                    }
                }
                let k=index;
                for(k in s){
                    if(j=="activity"){
                        gridsters[0].remove_widget($('#activity li').eq(k));
                    }
                   if(j=="tasks"){
                       gridsters[1].remove_widget($('#tasks li').eq(k));
                   }
                   if(j=="releases1"){
                       gridsters[2].remove_widget($('#releases1 li').eq(k));
                   }
                    if(j=="releases2"){
                        gridsters[3].remove_widget($('#releases2 li').eq(k));
                    }
                }
                let t=index;
                for(t in temp){
                    if(j=="activity"){
                        gridsters[0].add_widget(card_html('#aed9e9',temp[t].text,j), 2, 3, temp[t].col , temp[t].row);
                    }
                   if(j=="tasks"){
                       gridsters[1].add_widget(card_html('#f4e459',temp[t].text,j), 2, 3, temp[t].col , temp[t].row);
                   }
                   if(j=="releases1"){
                       gridsters[2].add_widget(card_html('#fff',temp[t].text,j), 2, 3, temp[t].col , temp[t].row);
                   }
                    if(j=="releases2"){
                        gridsters[3].add_widget(card_html('#fff',temp[t].text,j), 2, 3, temp[t].col , temp[t].row);
                    }
                }
            }

            $(document).on('click', 'li .add', function () {
                //获取点击按钮的最上层父元素
                var i = $(this).parent().parent().index();
                //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
                var j = $(this).parent().parent().parent().parent().attr('id');
                if (j === "activity") {
                    let s=getSerializeData(j);
                    s=JSON.parse(JSON.stringify(s));
                    s=Gridster.sort_by_row_and_col_asc(s);
                    let content = gridsters[0].serialize($(gridsters[0].$widgets[i]));
                    let index=returnIndex(s,content[0].row,content[0].col);
                    if(index!=0){
                        let temp=returnTemp(s);
                        process(temp,index,content[0].row,s,j);
                    }
                    gridsters[0].add_widget(card_html('#aed9e9','',j), 2, 3, content[0].col + 2, content[0].row);
                }
                if (j === "tasks") {
                    let s=getSerializeData(j);
                    s=JSON.parse(JSON.stringify(s));
                    s=Gridster.sort_by_row_and_col_asc(s);
                    let content = gridsters[1].serialize($(gridsters[1].$widgets[i]));
                    let index=returnIndex(s,content[0].row,content[0].col);
                    if(index!=0){
                        let temp=returnTemp(s);
                        process(temp,index,content[0].row,s,j);
                    }
                    gridsters[1].add_widget(card_html('#f4e459','',j), 2, 3, content[0].col + 2, content[0].row);
                }
                //通过j.substring(j.length-1)获取release后面的数字，从而确定gridster[x]中x代表的值
                if (j === "releases1") {
                    let s=getSerializeData(j);
                    s=JSON.parse(JSON.stringify(s));
                    s=Gridster.sort_by_row_and_col_asc(s);
                    let content = gridsters[2].serialize($(gridsters[2].$widgets[i]));
                    let index=returnIndex(s,content[0].row,content[0].col);
                    if(index!=0){
                        let temp=returnTemp(s);
                        process(temp,index,content[0].row,s,j);
                    }
                    gridsters[2].add_widget(card_html('#fff','',j), 2, 3, content[0].col + 2, content[0].row);
                }
                if (j === "releases2") {
                    let s=getSerializeData(j);
                    s=JSON.parse(JSON.stringify(s));
                    s=Gridster.sort_by_row_and_col_asc(s);
                    let content = gridsters[3].serialize($(gridsters[3].$widgets[i]));
                    let index=returnIndex(s,content[0].row,content[0].col);
                    if(index!=0){
                        let temp=returnTemp(s);
                        process(temp,index,content[0].row,s,j);
                    }
                    gridsters[3].add_widget(card_html('#fff','',j), 2, 3, content[0].col + 2, content[0].row);
                }
            });

            $(document).on('click', 'li .delete', function () {
                //获取点击按钮的最上层父元素
                let i = $(this).parent().parent().index();
                //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
                let j = $(this).parent().parent().parent().parent().attr('id');
                if (j === "activity") {
                    gridsters[0].remove_widget($('#activity li').eq(i));
                }
                if (j === "tasks") {
                    gridsters[1].remove_widget($('#tasks li').eq(i));
                }
                if (j === "releases1") {
                    gridsters[2].remove_widget($('#releases1 li').eq(i));
                }
                if (j === "releases2") {
                    gridsters[3].remove_widget($('#releases2 li').eq(i));
                }
            });

            $(document).on('click', 'li .write', function(){
                let pencil = this;
                layer.prompt({
                    formType: 2,
                    shadeClose: true, //点击遮罩关闭层
                    title: '请输入内容',
                    value:$(pencil.parentElement).find($('span'))[0].textContent,    // 文本默认值
                    area: ['500px', '240px'],     // 设置弹出层大小
                    btn: ['保存', '取消'],    // 自定义设置多个按钮
                    btn1: function(index, elem){
                        layer.close(index);
                    },
                    btnAlign: 'c',    // 设置按钮位置
                }, function(value, index, elem){
                    if (value) {
                        // parent.$('.card-text').text(value);  // this will change all cards
                        let s = card_innerEl(value);
                        $(pencil.parentElement).html(s);
                    }
                    layer.close(index);
                });
            });

            $(document).on('click', 'li .add_below', function () {
                //获取点击按钮的最上层父元素
                let i = $(this).parent().parent().index();
                //获取点击按钮的最外层父元素的id值，以判断是gridster[0]还是gridster[1]
                let j = $(this).parent().parent().parent().parent().attr('id');
                if(j=="releases1"){
                    let content = gridsters[2].serialize($(gridsters[2].$widgets[i]));
                    gridsters[2].add_widget(card_html('#fff','',"releases1"), 2, 3, content[0].col, content[0].row+3);
                }
                if(j=="releases2"){
                    let content = gridsters[3].serialize($(gridsters[3].$widgets[i]));
                    gridsters[3].add_widget(card_html('#fff','',"releases2"), 2, 3, content[0].col, content[0].row+3);
                }
            });
        });
    </script>
</body>

</html>
<!--Todo: 重新组织卡片的css样式，让卡片内元素继承卡片样式，使用margin和padding定位，使文字、按钮布局正常-->
